"use strict";var path=require("path"),fs=require("fs"),https=require("https"),express=require("express"),bodyParser=require("body-parser"),mongoose=require("mongoose"),session=require("express-session"),MongoDBStore=require("connect-mongodb-session")(session),csrf=require("csurf"),flash=require("connect-flash"),multer=require("multer"),uuidv4=require("uuid/v4"),helmet=require("helmet"),compression=require("compression"),morgan=require("morgan"),errorController=require("./controllers/error"),User=require("./models/user");console.log(process.env.NODE_ENV);var MONGODB_URI="mongodb+srv://".concat(process.env.MONGO_USER,":").concat(process.env.MONGO_PASSWORD,"@cluster0-hvut0.mongodb.net/").concat(process.env.MONGO_DEFAULT_DATABASE),app=express(),store=new MongoDBStore({uri:MONGODB_URI,collection:"sessions"}),csrfProtection=csrf(),fileStorage=multer.diskStorage({destination:function(e,s,r){r(null,"images")},filename:function(e,s,r){r(null,uuidv4()+"-"+s.originalname)}}),fileFilter=function(e,s,r){"image/png"===s.mimetype||"image/jpg"===s.mimetype||"image/jpeg"===s.mimetype?r(null,!0):r(null,!1)};app.set("view engine","ejs"),app.set("views","views");var adminRoutes=require("./routes/admin"),shopRoutes=require("./routes/shop"),authRoutes=require("./routes/auth"),accessLogStream=fs.createWriteStream(path.join(__dirname,"access.log"),{flags:"a"});app.use(helmet()),app.use(compression()),app.use(morgan("combined",{stream:accessLogStream})),app.use(bodyParser.urlencoded({extended:!1})),app.use(multer({storage:fileStorage,fileFilter:fileFilter}).single("image")),app.use(express.static(path.join(__dirname,"public"))),app.use("/images",express.static(path.join(__dirname,"images"))),app.use(session({secret:"my secret",resave:!1,saveUninitialized:!1,store:store})),app.use(csrfProtection),app.use(flash()),app.use(function(e,s,r){s.locals.isAuthenticated=e.session.isLoggedIn,s.locals.csrfToken=e.csrfToken(),r()}),app.use(function(s,e,r){if(!s.session.user)return r();User.findById(s.session.user._id).then(function(e){if(!e)return r();s.user=e,r()}).catch(function(e){r(new Error(e))})}),app.use("/admin",adminRoutes),app.use(shopRoutes),app.use(authRoutes),app.get("/500",errorController.get500),app.use(errorController.get404),app.use(function(e,s,r,o){console.log(e),r.redirect("/500")}),mongoose.connect(MONGODB_URI).then(function(e){app.listen(process.env.PORT||3e3)}).catch(function(e){console.log(e)});
"use strict";var mongoose=require("mongoose"),fileHelper=require("../util/file"),_require=require("express-validator/check"),validationResult=_require.validationResult,Product=require("../models/product");exports.getAddProduct=function(r,t,e){t.render("admin/edit-product",{pageTitle:"Add Product",path:"/admin/add-product",editing:!1,hasError:!1,errorMessage:null,validationErrors:[]})},exports.postAddProduct=function(r,t,e){var d=r.body.title,i=r.file,o=r.body.price,n=r.body.description;if(!i)return t.status(422).render("admin/edit-product",{pageTitle:"Add Product",path:"/admin/add-product",editing:!1,hasError:!0,product:{title:d,price:o,description:n},errorMessage:"Attached file is not an image.",validationErrors:[]});var a=validationResult(r);if(!a.isEmpty())return console.log(a.array()),t.status(422).render("admin/edit-product",{pageTitle:"Add Product",path:"/admin/add-product",editing:!1,hasError:!0,product:{title:d,price:o,description:n},errorMessage:a.array()[0].msg,validationErrors:a.array()});var u=i.path;new Product({title:d,price:o,description:n,imageUrl:u,userId:r.user}).save().then(function(r){console.log("Created Product"),t.redirect("/admin/products")}).catch(function(r){var t=new Error(r);return t.httpStatusCode=500,e(t)})},exports.getEditProduct=function(r,t,e){var d=r.query.edit;if(!d)return t.redirect("/");var i=r.params.productId;Product.findById(i).then(function(r){if(!r)return t.redirect("/");t.render("admin/edit-product",{pageTitle:"Edit Product",path:"/admin/edit-product",editing:d,product:r,hasError:!1,errorMessage:null,validationErrors:[]})}).catch(function(r){var t=new Error(r);return t.httpStatusCode=500,e(t)})},exports.postEditProduct=function(t,e,d){var r=t.body.productId,i=t.body.title,o=t.body.price,n=t.file,a=t.body.description,u=validationResult(t);if(!u.isEmpty())return e.status(422).render("admin/edit-product",{pageTitle:"Edit Product",path:"/admin/edit-product",editing:!0,hasError:!0,product:{title:i,price:o,description:a,_id:r},errorMessage:u.array()[0].msg,validationErrors:u.array()});Product.findById(r).then(function(r){return r.userId.toString()!==t.user._id.toString()?e.redirect("/"):(r.title=i,r.price=o,r.description=a,n&&(fileHelper.deleteFile(r.imageUrl),r.imageUrl=n.path),r.save().then(function(r){console.log("UPDATED PRODUCT!"),e.redirect("/admin/products")}))}).catch(function(r){var t=new Error(r);return t.httpStatusCode=500,d(t)})},exports.getProducts=function(r,t,e){Product.find({userId:r.user._id}).then(function(r){console.log(r),t.render("admin/products",{prods:r,pageTitle:"Admin Products",path:"/admin/products"})}).catch(function(r){var t=new Error(r);return t.httpStatusCode=500,e(t)})},exports.deleteProduct=function(t,e,d){var i=t.params.productId;Product.findById(i).then(function(r){return r?(fileHelper.deleteFile(r.imageUrl),Product.deleteOne({_id:i,userId:t.user._id})):d(new Error("Product not found"))}).then(function(){console.log("DESTROYED PRODUCT"),e.status(200).json({message:"Success"})}).catch(function(r){e.status(500).json({message:"Deleting product failed"})})};
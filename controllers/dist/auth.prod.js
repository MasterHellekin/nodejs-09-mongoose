"use strict";var crypto=require("crypto"),bcrypt=require("bcryptjs"),sgMail=require("@sendgrid/mail"),_require=require("express-validator/check"),validationResult=_require.validationResult,User=require("../models/user");sgMail.setApiKey("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"),exports.getLogin=function(e,r,t){var o=e.flash("error");o=0<o.length?o[0]:null,r.render("auth/login",{path:"/login",pageTitle:"Login",isAuthenticated:!1,errorMessage:o,oldInput:{email:"",password:""},validationErrors:[]})},exports.getSignup=function(e,r,t){var o=e.flash("error");o=0<o.length?o[0]:null,r.render("auth/signup",{path:"/signup",pageTitle:"Signup",errorMessage:o,oldInput:{email:"",password:"",confirmPassword:""},validationErrors:[]})},exports.postLogin=function(t,o,s){var n=t.body.email,a=t.body.password,e=validationResult(t);if(!e.isEmpty())return o.status(422).render("auth/login",{path:"/login",pageTitle:"Login",isAuthenticated:!1,errorMessage:e.array()[0].msg,oldInput:{email:n,password:a},validationErrors:e.array()});User.findOne({email:n}).then(function(r){if(!r)return o.status(422).render("auth/login",{path:"/login",pageTitle:"Login",isAuthenticated:!1,errorMessage:"Invalid email or password",oldInput:{email:n,password:a},validationErrors:[]});bcrypt.compare(a,r.password).then(function(e){return e?(t.session.isLoggedIn=!0,t.session.user=r,t.session.save(function(e){console.log(e),o.redirect("/")})):o.status(422).render("auth/login",{path:"/login",pageTitle:"Login",isAuthenticated:!1,errorMessage:"Invalid email or password",oldInput:{email:n,password:a},validationErrors:[]})}).catch(function(e){console.log(e),o.redirect("/login")})}).catch(function(e){var r=new Error(e);return r.httpStatusCode=500,s(r)})},exports.postSignup=function(e,r,t){var o=e.body.email,s=e.body.password,n=validationResult(e);if(!n.isEmpty())return console.log(n.array()),r.status(422).render("auth/signup",{path:"/signup",pageTitle:"Signup",errorMessage:n.array()[0].msg,oldInput:{email:o,password:s,confirmPassword:e.body.confirmPassword},validationErrors:n.array()});bcrypt.hash(s,12).then(function(e){return new User({email:o,password:e,cart:{item:[]}}).save()}).then(function(e){return r.redirect("/login"),sgMail.send({from:"clsjs1994@gmail.com",to:o,subject:"Signup succeeded",html:"<h1>You successfully signed up!</h1>"})}).catch(function(e){var r=new Error(e);return r.httpStatusCode=500,t(r)})},exports.postLogout=function(e,r,t){e.session.destroy(function(e){console.log(e),r.redirect("/")})},exports.getReset=function(e,r,t){var o=e.flash("error");o=0<o.length?o[0]:null,r.render("auth/reset",{path:"/reset",pageTitle:"Reset Password",errorMessage:o})},exports.postReset=function(o,s,n){crypto.randomBytes(32,function(e,r){if(e)return console.log(e),s.redirect("/reset");var t=r.toString("hex");User.findOne({email:o.body.email}).then(function(e){return e?(e.resetToken=t,e.resetTokenExpiration=Date.now()+36e5,e.save()):(o.flash("error","No account with that email found"),s.redirect("/reset"))}).then(function(e){s.redirect("/"),sgMail.send({from:"clsjs1994@gmail.com",to:o.body.email,subject:"Password reset",html:'\n          <p>You requested a password reset</p>\n          <p>Click this <a href="http://localhost:3000/reset/'.concat(t,'">link</a> to set a new password</p>\n          ')})}).catch(function(e){var r=new Error(e);return r.httpStatusCode=500,n(r)})})},exports.getNewPassword=function(t,o,s){var n=t.params.token;User.findOne({resetToken:n,resetTokenExpiration:{$gt:Date.now()}}).then(function(e){var r=t.flash("error");r=0<r.length?r[0]:null,o.render("auth/new-password",{path:"/new-password",pageTitle:"New Password",errorMessage:r,userId:e._id.toString(),passwordToken:n})}).catch(function(e){var r=new Error(e);return r.httpStatusCode=500,s(r)})},exports.postNewPassword=function(e,r,t){var o,s=e.body.password,n=e.body.userId,a=e.body.passwordToken;User.findOne({resetToken:a,resetTokenExpiration:{$gt:Date.now()},_id:n}).then(function(e){return o=e,bcrypt.hash(s,12)}).then(function(e){return o.password=e,o.resetToken=void 0,o.resetTokenExpiration=void 0,o.save()}).then(function(e){r.redirect("/login")}).catch(function(e){var r=new Error(e);return r.httpStatusCode=500,t(r)})};